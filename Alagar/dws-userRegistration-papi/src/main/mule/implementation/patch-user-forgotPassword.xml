<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:os="http://www.mulesoft.org/schema/mule/os" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd">
	<os:config name="ObjectStore_Config" doc:name="ObjectStore Config" doc:id="531d2d72-9813-48f7-baec-92e1d032c52d" >
		<os:connection />
	</os:config>
	<os:object-store name="Object_store" doc:name="Object store" doc:id="e439f66b-ffec-4900-ae34-deb4093aada2" config-ref="ObjectStore_Config" />
	<os:config name="ObjectStore_Config1" doc:name="ObjectStore Config" doc:id="70197268-1c66-4f22-b147-9821c91a7cb9" >
		<os:connection />
	</os:config>
	<os:object-store name="OTPGenerationStore" doc:name="Object store" doc:id="572d016e-8411-445d-88d6-83e616da013c"/>
	<sub-flow name="patch-user-forgotPasswordSub_Flow" doc:id="123c597e-73ed-478f-84a3-d64c7bf94ac6" >
		<ee:transform doc:name="Set User Credentials Variable" doc:id="9929d641-f4ad-4764-9945-4f98b3a01409" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="vUserCredentials" ><![CDATA[%dw 2.0
output application/json
---
{
	email: payload.email,
	password:payload.password 
}
]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<http:request method="GET" doc:name="Request for user Registration sapi" doc:id="f7e524b1-5c2e-4248-a79c-08c2395149cc" config-ref="HTTP-Request-config-userRegistration-sapi" path="${userRegistration-sapi.signup}">
			<http:headers ><![CDATA[#[output application/java
---
{
	client_id: "aasss",
   client_secret: "aaaa"
//	client_id: p('secure::userRegistration-sapi.client_id'),
//   client_secret: p('secure::userRegistration-sapi.client_secret')
}]]]></http:headers>
			<http:uri-params ><![CDATA[#[output application/java
---
{
	"email" : payload.email
}]]]></http:uri-params>
		</http:request>
		<choice doc:name="Choice" doc:id="c3498be0-ca65-4199-841e-2378570f1b9b" >
			<when expression="#[payload.password[0] == vars.vUserCredentials.password]" >
				<!-- [STUDIO:"Raise error"]<raise-error doc:name="Raise error" doc:id="e7024205-a0c1-49b0-9085-5f4789ee6c5f" type="ERROR:PASSWORD" description="Password should not be same as your last 1 password(s)" /> [STUDIO] -->
				<logger level="INFO" doc:name="Logger" doc:id="a7f8182e-20de-4d11-9e7e-1acc432441d0" message="Password should not be same as your last 1 password(s)"/>
			</when>
			<when expression="sizeOf(payload) &gt;0" >
				<ee:transform doc:name="Transform Message" doc:id="15ca8919-5c6b-4c08-aa2f-d04f30c8b23f">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/java
---
vars.vUserCredentials]]></ee:set-payload>
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="vOTPMessage" ><![CDATA["reset your password"]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<os:store doc:id="4b95d398-9650-4d63-9ba1-f6e5498c7de6" key="#[vars.vUserCredentials.email]" objectStore="Object_store" doc:name="Forgot Password Details Store" />
				<flow-ref doc:name="Flow Reference" doc:id="d3daecd1-d3ec-4826-86d0-1240b5d0ca2e" name="patch-user-forgotPasswordSub_Flow1" />
			</when>
			<otherwise >
				<!-- [STUDIO:"Raise error"]<raise-error doc:name="Raise error" doc:id="5c0c1225-e8b6-44f4-bd1a-730dc3406c4c" type="ERROR:NODATAFOUND" description="No data found for the provided email ID in our system. Please check your email ID and try again." /> [STUDIO] -->
				<logger level="INFO" doc:name="Logger" doc:id="54a919cf-7345-47a9-b423-0ef2fda3e9f0" message="No data found for the provided email ID in our system. Please check your email ID and try again."/>
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="patch-user-forgotPasswordSub_Flow1" doc:id="4a66985d-d4de-4d4d-a033-a964011475cb" >
		<ee:transform doc:name="Transform Message" doc:id="37290a3b-93b5-4761-94ef-2da7f18341d8">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
randomInt(1000000)]]></ee:set-payload>
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="vOTPGeneration" ><![CDATA[%dw 2.0
output application/json
---
randomInt(1000000)]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<choice doc:name="Choice" doc:id="a07e4aff-1846-4fb6-a7dd-3890fe3e7ffe" >
			<when expression="#[sizeOf(vars.otp) == 6]" >
				<os:store doc:name="OTP Store" doc:id="daaf0a5c-36c7-47ec-8250-b67d46a006f8" key="#[vars.vUserCredentials.email]" objectStore="OTPGenerationStore" >
					<os:value ><![CDATA[#[vars.vOTPGeneration]]]></os:value>
				</os:store>
				<ee:transform doc:name="Transform Message" doc:id="99897239-186b-44c0-a875-cb9554c414f3">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  "to": [
    "alagarsamyp@dwinsoft.in"
  ],
  "cc": [
    "hr@dwinsoft.in"
  ],
  "subject": "Sample Notification Subject",
  "body": "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\" />\n  <title>OTP Verification</title>\n</head>\n<body style=\"font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px;\">\n  <div style=\"max-width: 500px; margin: auto; background-color: #0d2345; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); overflow: hidden; color: #ffffff;\">\n    <div style=\"background-color: #ffffff; padding: 15px; text-align: center;\">\n      <img src=\"https://www.dwinsoft.in/images/dwinsoftLogo_dark.png\" alt=\"Dwinsoft Logo\" style=\"width: 140px;\" />\n    </div>\n    <div style=\"padding: 30px;\">\n      <h2>Your One-Time Password (OTP)</h2>\n      <p style=\"font-size: 16px;\">Use the OTP below to complete your verification:</p>\n      <div id=\"otpBox\" style=\"margin: 20px 0; padding: 20px; background-color: #ffffff; border: 2px dashed #ffffff; border-radius: 8px; text-align: center;\">\n        <span id=\"otpValue\" style=\"font-size: 28px; font-weight: bold; color: #0d2345;\"> " ++ vars.vOTPGeneration ++ "</span>\n        <img src=\"https://cdn-icons-png.flaticon.com/128/126/126498.png\" alt=\"Copy OTP\" title=\"Copy OTP\" onclick=\"copyOTP()\" style=\"cursor: pointer; margin-left: 12px; width: 20px; height: 20px; vertical-align: middle;\" />\n        <p id=\"copyMsg\" style=\"color: green; font-size: 13px; display: none; margin-top: 8px;\">OTP copied to clipboard!</p>\n      </div>\n      <div id=\"resendMessage\" style=\"display: none; margin: 20px 0; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 6px; color: #000; font-size: 14px; text-align: center;\">\n        The OTP has expired. Please click <strong>\"Resend OTP\"</strong>.\n      </div>\n      <p style=\"font-size: 14px; color: #ccc;\">If you didnâ€™t request this, you can ignore this email.</p>\n    </div>\n  </div>\n  <script>\n    function copyOTP() {\n      const otp = document.getElementById(\"otpValue\").textContent;\n      navigator.clipboard.writeText(otp).then(() => {\n        const msg = document.getElementById(\"copyMsg\");\n        msg.style.display = \"block\";\n        setTimeout(() => msg.style.display = \"none\", 2000);\n      });\n    }\n    setTimeout(() => {\n      document.getElementById('otpBox').style.display = 'none';\n      document.getElementById('resendMessage').style.display = 'block';\n    }, 60000);\n  </script>\n</body>\n</html>",
  "from": "alagarsamyp@dwinsoft.in",
  "bodyType": "text/html"
}
]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<http:request method="GET" doc:name="Request" doc:id="838a2c6a-d7eb-49e6-933e-0a0551b19be7" config-ref="HTTP-Request-config-userRegistration-sapi" path="${notification-sapi.emailPath}"/>
				<set-payload value="#[&quot;You'll receive an email which contains OTP. Please use that OTP for verifying your account.&quot;]" doc:name="Set Payload1" doc:id="00eec851-7049-44ac-be97-bd83f7116374" />
			</when>
		</choice>
	</sub-flow>
</mule>
