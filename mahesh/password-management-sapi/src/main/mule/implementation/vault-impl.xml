<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="create_vault-implSub_Flow" doc:id="8ca649c8-32ef-4db4-80f1-57b4df0a8008">
		<logger level="INFO" doc:name="Before Db request" doc:id="2a25b06b-2b20-4881-93eb-ea4f81a88ea1" message="Before Db request | correlationId : #[correlationId]" />
		<try doc:name="Try" doc:id="fef4013a-e675-4605-ad05-ff7b25a69828">
			<db:insert doc:name="create vault in db" doc:id="518cdddc-156a-43ba-8056-698ec3e50b82" config-ref="Database_Config">
				<db:sql><![CDATA[INSERT INTO public.vault (vault_id, vault_name, username) VALUES(:vault_id, :vault_name, :username);]]></db:sql>
				<db:input-parameters><![CDATA[#[payload]]]></db:input-parameters>
			</db:insert>
		</try>
		<ee:transform doc:name="response payload" doc:id="3be34340-424c-4f5f-96aa-f0a3dbc126b9">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{"message" : "User registered successfully"
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="After Db request" doc:id="a61c1ea8-38e8-4cd3-8103-dbc17e875524" message="After Db request  | correlationId : #[correlationId]" />
	</sub-flow>
	<sub-flow name="get_vaults-implSub_Flow" doc:id="370d6d28-4c4e-4d43-a4e9-86738c24fcc0" >
		<logger level="INFO" doc:name="Before Db request" doc:id="84150922-ec7d-4f24-ae2e-1e6799a4d058" message="Before Db request | correlationId : #[correlationId]" />
		<try doc:name="Try" doc:id="1821c5d1-a9e0-463a-8448-1a631ec3b5ae" >
			<db:select doc:name="fetch vaults from db" doc:id="254dab97-daeb-422e-ac4e-e2bc510bef92" config-ref="Database_Config" >
				<db:sql ><![CDATA[#[payload]]]></db:sql>
			</db:select>
		</try>
		<ee:transform doc:name="response payload" doc:id="a9f94127-c1a4-4a98-8cca-60ad59095f87" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="After Db request" doc:id="6fe32369-5fc9-49fa-8977-a28b7c3e7445" message="After Db request | correlationId : #[correlationId]" />
	</sub-flow>
	<sub-flow name="update_vault-implSub_Flow" doc:id="e0cf2898-0752-4465-bbbe-291ce2881ad7" >
		<logger level="INFO" doc:name="Before Db request" doc:id="45f12b35-2885-4a26-9cb4-ce30de62e02d" message="Before Db request | correlationId : #[correlationId]" />
		<try doc:name="Try" doc:id="d98a126e-d730-4be9-b1d5-452c8490dbf9" >
			<db:update doc:name="Update vault by vault id" doc:id="9cb9bbd8-ed49-4347-aade-3ab3051fcd62" config-ref="Database_Config">
				<db:sql ><![CDATA[UPDATE public.vault SET vault_name= :vault_name WHERE vault_id= :vault_id;]]></db:sql>
				<db:input-parameters ><![CDATA[#[%dw 2.0
output application/json
---
{"vault_name" : payload.vault_name,
"vault_id"	: attributes.uriParams.vault_id
}]]]></db:input-parameters>
			</db:update>
		</try>
		<ee:transform doc:name="response payload" doc:id="ba1671fd-9f67-4f69-9075-97845c1491f6" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{"message" : "Vault updated successfully"
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="After Db request" doc:id="1eb2d758-5a25-46f9-aef5-d537335dbadd" message="After Db request  | correlationId : #[correlationId]" />
	</sub-flow>
	<sub-flow name="delete_vault_by_Id-implSub_Flow" doc:id="a1ba8ec9-6bf1-4aae-8951-50325adec120" >
		<logger level="INFO" doc:name="Before Db request" doc:id="3ec80ad8-30e7-4fd2-a504-b3e16e8844d5" message="Before Db request | correlationId : #[correlationId]" />
		<try doc:name="Try" doc:id="a697be86-e9f8-46b2-8902-2ae5262560d3" >
			<db:delete doc:name="delete vault by vault id" doc:id="4d003808-dc04-4472-a638-971894891542" config-ref="Database_Config" >
				<db:sql ><![CDATA[#[payload]]]></db:sql>
			</db:delete>
		</try>
		<ee:transform doc:name="Response payload" doc:id="d5739dc0-7f0b-4d7b-933b-0bfe39c48569" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{"message" : "Vault deleted successfully"
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="After Db request" doc:id="0e4db725-95e5-4e41-9c86-7a82a4d37efd" message="After Db request | correlationId : #[correlationId]" />
	</sub-flow>
	<sub-flow name="create_secrets-implSub_Flow" doc:id="e7f44f11-c02c-417e-85be-37126bb7f164" >
		<logger level="INFO" doc:name="Before Db request" doc:id="ee75fcdd-5761-404f-9987-655738e77f6b" message="Before Db request | correlationId : #[correlationId]" />
		<try doc:name="Try" doc:id="36ddfff6-dfc4-49a4-85ad-da5abeaabe2c" >
			<db:insert doc:name="create secrets in db" doc:id="fbdee112-8f30-49bb-951d-090c80f6d990" config-ref="Database_Config" >
				<db:sql ><![CDATA[INSERT INTO public.secret (secrets, vault_id, category) VALUES(:secrets, :vault_id, :category);]]></db:sql>
				<db:input-parameters ><![CDATA[#[%dw 2.0
output application/json
---
payload ++ {"vault_id": attributes.uriParams.vault_id}]]]></db:input-parameters>
			</db:insert>
		</try>
		<ee:transform doc:name="response payload" doc:id="9cdca237-cbab-4bad-8e43-980219716ec1" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{"message" : "User registered successfully"
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="After Db request" doc:id="87c2cb9f-98ae-4869-b712-f418c0e692eb" message="After Db request  | correlationId : #[correlationId]" />
	</sub-flow>
	<sub-flow name="get_secrets-implSub_Flow" doc:id="47475eae-35a3-43ba-a239-ebf1c326a121" >
		<logger level="INFO" doc:name="Before Db request" doc:id="1d5b19d8-b9ae-4968-88ca-a0e0f9a0a496" message="Before Db request | correlationId : #[correlationId]" />
		<try doc:name="Try" doc:id="28f9e0e2-7abf-4d48-baee-2e62b4d1c9d2" >
			<db:select doc:name="get secrets from db" doc:id="23394a89-41bb-4ef4-b610-20db35f2cd73" config-ref="Database_Config" >
				<db:sql ><![CDATA[#[payload]]]></db:sql>
			</db:select>
		</try>
		<ee:transform doc:name="response payload" doc:id="c1cafe0b-1472-4a82-b2e6-f598f3f72f29" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
import * from dw::core::Binaries
output application/json
---
payload map {"category": $.category,
	"secrets": read(fromBase64($.secrets), "application/json")
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="After Db request" doc:id="b0f083b9-d1e3-45e0-851f-e5815c71863b" message="After Db request | correlationId : #[correlationId]" />
	</sub-flow>
	<sub-flow name="update_secrets-implSub_Flow" doc:id="d74edbb3-afb9-41a8-b775-855989eecc56" >
		<logger level="INFO" doc:name="Before Db request" doc:id="64cc5ee2-b471-410c-9104-a8832c0df0ba" message="Before Db request | correlationId : #[correlationId]" />
		<try doc:name="Try" doc:id="83015b6e-0861-4156-94f0-b2fe55f7621c" >
			<db:update doc:name="update secrets by vault id and category" doc:id="c3f75e2f-0e83-4c1e-ad31-2f468b435391" config-ref="Database_Config" >
				<db:sql ><![CDATA[UPDATE public.secret SET secrets= :secrets WHERE vault_id= :vault_id and category= :category;]]></db:sql>
				<db:input-parameters ><![CDATA[#[%dw 2.0
output application/json
---
{"category" : attributes.uriParams.category ,
"vault_id"	: attributes.uriParams.vault_id ,
"secrets" : payload.secrets
}]]]></db:input-parameters>
			</db:update>
		</try>
		<ee:transform doc:name="response payload" doc:id="a0662987-5d01-4ee3-9106-82940a07f24c" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{"message" : "Secrets updated successfully"
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="After Db request" doc:id="302feb1a-41e9-4ed2-b079-97c53bae128f" message="After Db request  | correlationId : #[correlationId]" />
	</sub-flow>
	<sub-flow name="delete_secrets_by_Id-implSub_Flow" doc:id="d2f9ab88-3244-419d-9e36-d4de65f113d7" >
		<logger level="INFO" doc:name="Before Db request" doc:id="16bcb5f9-6eac-4d97-acaa-1152962b99ab" message="Before Db request | correlationId : #[correlationId]" />
		<try doc:name="Try" doc:id="0d484ee4-7348-4130-aa28-1d40ae7a80ff" >
			<db:delete doc:name="delete secrets using vault id and category " doc:id="773b30fd-a000-4379-b7ee-9e4e9c82e435" config-ref="Database_Config" >
				<db:sql ><![CDATA[#[payload]]]></db:sql>
			</db:delete>
		</try>
		<ee:transform doc:name="Response payload" doc:id="81417563-9556-4aae-b25e-d020995dc772" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{"message" : "Secrets deleted successfully"
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="After Db request" doc:id="822f726c-a22b-4369-92ca-d2c2b70c94cd" message="After Db request | correlationId : #[correlationId]" />
	</sub-flow>
	<sub-flow name="assign_vault-implSub_Flow" doc:id="5ba20310-99cc-47b0-b640-5a5c31004b05" >
		<logger level="INFO" doc:name="Before Db request" doc:id="38284ffe-5102-4dd7-82ea-84c5ee875dea" message="Before Db request | correlationId : #[correlationId]" />
		<try doc:name="Try" doc:id="7b2ada97-19b9-4f99-8d0e-a483866c7b0a" >
			<db:insert doc:name="assign vaults to requester" doc:id="6059fc0f-38fd-420b-b9ac-be485a295e2b" config-ref="Database_Config" >
				<db:sql ><![CDATA[INSERT INTO public.assign_vault (vault_owner, vault_requester, "access", "vault_id") VALUES(:vault_owner, :vault_requester, :access, :vault_id);]]></db:sql>
				<db:input-parameters ><![CDATA[#[%dw 2.0
output application/json
---
payload]]]></db:input-parameters>
			</db:insert>
		</try>
		<ee:transform doc:name="response payload" doc:id="6263a442-2107-478c-a845-747b8c49dc8c" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{"message" : "User registered successfully"
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="After Db request" doc:id="31a3ca0e-48c8-437d-aece-e18e0568e241" message="After Db request  | correlationId : #[correlationId]" />
	</sub-flow>
	<sub-flow name="get_assignVault-implSub_Flow" doc:id="a1f8e758-e713-4b60-9ec6-077eff01a7ca" >
		<logger level="INFO" doc:name="Before Db request" doc:id="1583ae6c-9b06-4835-9dfa-38a19216c5d0" message="Before Db request | correlationId : #[correlationId]" />
		<try doc:name="Try" doc:id="264417ff-ef73-4faf-898e-e0c25f40850a" >
			<db:select doc:name="fetch assign vault" doc:id="3bde9264-efc5-4365-bf68-25a9a565a6f1" config-ref="Database_Config" >
				<db:sql ><![CDATA[SELECT * FROM public.assign_vault WHERE vault_id= :vault_id and access= :access and vault_owner= :vault_owner and vault_requester= :vault_requester;]]></db:sql>
				<db:input-parameters ><![CDATA[#[%dw 2.0
output application/json
---
{"vault_id": attributes.uriParams.vault_id,
"access" : attributes.queryParams.access,
"vault_owner" : attributes.uriParams.vault_owner,
"vault_requester": attributes.uriParams.vault_requester	
}]]]></db:input-parameters>
			</db:select>
		</try>
		<ee:transform doc:name="response payload" doc:id="36059223-eb10-4923-94f1-8b83566ca8a6" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="After Db request" doc:id="50313afc-bbef-4fdb-890a-689f0facfd39" message="After Db request | correlationId : #[correlationId]" />
	</sub-flow>
</mule>
