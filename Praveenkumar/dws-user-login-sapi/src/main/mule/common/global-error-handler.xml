<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<error-handler name="global-apikit-error-handler" doc:id="275de09a-b4e7-49fd-a60d-a63c1f372875" >
		<on-error-propagate type="APIKIT:BAD_REQUEST" enableNotifications="true" logException="true">
                <logger level="INFO" doc:name="Start Common Error Handler Log" doc:id="29c5ad06-8a4d-4616-bd68-b9f5a01de2ef" message="***Bad Request - Invalid input received. CorrelationId: #[correlationId]***"/>
			<ee:transform doc:name="Set Error Payload &amp; Status Code">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	transaction: "Request Correlation ID :" ++  " " ++ correlationId,
	apiName: p('api.name'),
	timestamp:  now(),
	infoMessage : { 
        statusCode: 400 as Number,
		errorType: error.errorType.namespace default "" ++ ":" ++ error.errorType.identifier default "",
   	    message: error.detailedDescription default""
     } 
}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus"><![CDATA[400]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
			<logger level="INFO" doc:name="End  Common Error Handler Log" doc:id="71324949-f376-433f-9fbd-a6ad801c1367" message="***Bad Request handled successfully. Responding with  400. CorrelationId: #[correlationId]***"/>
            
</on-error-propagate>


            <on-error-propagate type="APIKIT:NOT_FOUND" enableNotifications="true" logException="true">
                <logger level="INFO" doc:name="Start Common Error Handler Log" doc:id="b09f32fa-7815-4511-94a4-a601f43d6a4c" message="***Requested resource not found. CorrelationId: #[correlationId]***" />
			<ee:transform doc:name="Set Error Payload &amp; Status Code">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	transaction: "Request Correlation ID :" ++  " " ++ correlationId,
	apiName: p('api.name'),
	timestamp:  now(),
	infoMessage : { 
        statusCode: 404 as Number,
		errorType: error.errorType.namespace default "" ++ " : " ++ error.errorType.identifier default "",
   	    message: error.detailedDescription default""
     } 
}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus"><![CDATA[404]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
			<logger level="INFO" doc:name="End  Common Error Handler Log" doc:id="b7786d0c-08aa-476f-ab4c-f408e82a2ecc" message="***404 response sent - Resource not found. CorrelationId: #[correlationId]***" />
            
</on-error-propagate>
            <on-error-propagate type="APIKIT:METHOD_NOT_ALLOWED" enableNotifications="true" logException="true">
                <logger level="INFO" doc:name="Start Common Error Handler Log" doc:id="42477d02-03d0-4d51-a248-2c34cb945f9f" message="***Invalid method used. CorrelationId: #[correlationId]***" />
			<ee:transform doc:name="Set Error Payload &amp; Status Code">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	transaction: "Request Correlation ID :" ++  " " ++ correlationId,
	apiName: p('api.name'),
	timestamp:  now(),
	infoMessage : { 
        statusCode: 405 as Number,
		errorType: error.errorType.namespace default "" ++ " : " ++ error.errorType.identifier default "",
   	    message: error.detailedDescription default""
     } 
}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus"><![CDATA[405]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
			<logger level="INFO" doc:name="End  Common Error Handler Log" doc:id="9ffc7549-b78b-423d-b737-418f75c1ef2e" message="***405 response sent - Method Not Allowed. CorrelationId: #[correlationId]***" />
            
</on-error-propagate>
            <on-error-propagate type="APIKIT:NOT_ACCEPTABLE" enableNotifications="true" logException="true">
                <logger level="INFO" doc:name="Start Common Error Handler Log" doc:id="b3bbc5f6-c170-45ef-aee1-418ac9d27302" message="***Invalid method used. CorrelationId: #[correlationId]***" />
			<ee:transform doc:name="Set Error Payload &amp; Status Code">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	transaction: "Request Correlation ID :" ++  " " ++ correlationId,
	apiName: p('api.name'),
	timestamp:  now(),
	infoMessage : { 
        statusCode: 406 as Number,
		errorType: error.errorType.namespace default "" ++ " : " ++ error.errorType.identifier default "",
   	    message: error.detailedDescription default""
     } 
}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus"><![CDATA[406]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
			<logger level="INFO" doc:name="End  Common Error Handler Log" doc:id="57f0d742-44e6-47cc-90d5-01c1d99c639c" message="***405 response sent - Method Not Allowed. CorrelationId: #[correlationId]***" />
            
</on-error-propagate>
            <on-error-propagate type="APIKIT:UNSUPPORTED_MEDIA_TYPE" enableNotifications="true" logException="true">
                <logger level="INFO" doc:name="Start Common Error Handler Log" doc:id="8abb79cc-9645-46f7-a344-a8ab0b86ada2" message="***Client sent an unsupported media type in request. CorrelationId: #[correlationId]***" />
			<ee:transform doc:name="Set Error Payload &amp; Status Code">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	transaction: "Request Correlation ID :" ++  " " ++ correlationId,
	apiName: p('api.name'),
	timestamp:  now(),
	infoMessage : { 
        statusCode: 415 as Number,
		errorType: error.errorType.namespace default "" ++ " : " ++ error.errorType.identifier default "",
   	    message: error.detailedDescription default""
     } 
}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus"><![CDATA[415]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
			<logger level="INFO" doc:name="End  Common Error Handler Log" doc:id="ce560610-be00-4f71-975d-c438ff9ef381" message="***415 response sent - Unsupported Media Type. CorrelationId: #[correlationId]***" />
            
</on-error-propagate>
            <on-error-propagate type="APIKIT:NOT_IMPLEMENTED" enableNotifications="true" logException="true">
                <logger level="INFO" doc:name="Start Common Error Handler Log" doc:id="1b4d96e6-403c-4269-9f88-6008c2e1cf39" message="***Attempt to access an unimplemented feature. CorrelationId: #[correlationId]***" />
			<ee:transform doc:name="Set Error Payload &amp; Status Code">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	transaction: "Request Correlation ID :" ++  " " ++ correlationId,
	apiName: p('api.name'),
	timestamp:  now(),
	infoMessage : { 
        statusCode: 501 as Number,
		errorType: error.errorType.namespace default "" ++ " : " ++ error.errorType.identifier default "",
   	    message: error.detailedDescription default""
     } 
}]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[501]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<logger level="INFO" doc:name="End  Common Error Handler Log" doc:id="df64f13d-c494-401e-9d08-00ff2ed4d3e2" message="***501 response sent - Not Implemented. CorrelationId: #[correlationId]***" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="156b4228-2dfb-45a4-b947-2cc51d25bd72" type="ANY" >
			<logger level="INFO" doc:name="Start Common Error Handler Log" doc:id="c9475689-6e4b-44f9-9130-f8bb92cf85d8" message="***Unhandled error occurred in flow. CorrelationId: #[correlationId]***" />
			<ee:transform doc:name="Set Error Payload &amp; Status Code" doc:id="7cb1d06f-4672-4990-a1d7-5b3294f560ba" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	transaction: "Request Correlation ID :" ++  " " ++ correlationId,
	apiName: p('api.name'),
	timestamp:  now(),
	infoMessage : { 
        statusCode: 500 as Number,
		errorType: error.errorType.namespace default "" ++ " : " ++ error.errorType.identifier default "",
   	    message: error.detailedDescription default""
     } 
}]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[500]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<logger level="INFO" doc:name="End  Common Error Handler Log" doc:id="867e7f40-0eae-4fd0-93fb-65aa89ade8af" message="***Generic error response sent -500. CorrelationId: #[correlationId]***" />
		</on-error-propagate>
	</error-handler>
	<error-handler name="global-database-error-handler" doc:id="e9538602-347c-49a4-ab70-2e9b033037fe" >
<on-error-propagate type="DB:QUERY_EXECUTION" enableNotifications="true" logException="true">
    <logger level="ERROR" doc:name="Start DB Error Handler Log" 
        message="***Database Query Execution Error occurred. CorrelationId: #[correlationId]***" />
    
    <ee:transform doc:name="Set DB Error Payload &amp; Status Code">
        <ee:message>
            <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    transaction: "Request Correlation ID :" ++ " " ++ correlationId,
    apiName: p('api.name'),
    timestamp: now(),
    infoMessage : { 
        statusCode: 500 as Number,
        errorType: error.errorType.namespace default "" ++ " : " ++ error.errorType.identifier default "",
        message: error.detailedDescription default ""
    }
}]]></ee:set-payload>
        </ee:message>
        <ee:variables>
            <ee:set-variable variableName="httpStatus"><![CDATA[500]]></ee:set-variable>
        </ee:variables>
    </ee:transform>
    
    <logger level="ERROR" doc:name="End DB Error Handler Log" 
        message="***500 response sent - DB Query Execution Failed. CorrelationId: #[correlationId]***" />
</on-error-propagate>
<on-error-propagate type="DB:CONNECTIVITY" enableNotifications="true" logException="true">
    <logger level="ERROR" doc:name="Start DB Connectivity Error Handler Log" 
        message="***Database Connectivity Error occurred. CorrelationId: #[correlationId]***" />
    
    <ee:transform doc:name="Set DB Connectivity Error Payload &amp; Status Code">
        <ee:message>
            <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    transaction: "Request Correlation ID :" ++ " " ++ correlationId,
    apiName: p('api.name'),
    timestamp: now(),
    infoMessage : { 
        statusCode: 503 as Number,
        errorType: error.errorType.namespace default "" ++ " : " ++ error.errorType.identifier default "",
        message: error.detailedDescription default ""
    }
}]]></ee:set-payload>
        </ee:message>
        <ee:variables>
            <ee:set-variable variableName="httpStatus"><![CDATA[503]]></ee:set-variable>
        </ee:variables>
    </ee:transform>
    
    <logger level="ERROR" doc:name="End DB Connectivity Error Handler Log" 
        message="***503 response sent - DB Connectivity Issue. CorrelationId: #[correlationId]***" />
</on-error-propagate>
<on-error-propagate type="DB:BAD_SQL_SYNTAX" enableNotifications="true" logException="true">
    <logger level="ERROR" doc:name="Start DB Bad SQL Syntax Error Log" 
        message="***Bad SQL Syntax Error occurred. CorrelationId: #[correlationId]***" />
    
    <ee:transform doc:name="Set Bad SQL Syntax Error Payload &amp; Status Code">
        <ee:message>
            <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    transaction: "Request Correlation ID :" ++ " " ++ correlationId,
    apiName: p('api.name'),
    timestamp: now(),
    infoMessage : { 
        statusCode: 400 as Number,
        errorType: error.errorType.namespace default "" ++ " : " ++ error.errorType.identifier default "",
        message: error.detailedDescription default ""
    }
}]]></ee:set-payload>
        </ee:message>
        <ee:variables>
            <ee:set-variable variableName="httpStatus"><![CDATA[400]]></ee:set-variable>
        </ee:variables>
    </ee:transform>
    
    <logger level="ERROR" doc:name="End DB Bad SQL Syntax Error Log" 
        message="***400 response sent - Bad SQL Syntax Detected. CorrelationId: #[correlationId]***" />
</on-error-propagate>
<on-error-propagate type="ANY" enableNotifications="true" logException="true" doc:name="On Error Propagate - DB ANY Error">
    <logger level="ERROR" doc:name="Start DB ANY Error Log" 
        message="***Unhandled DB connector error detected. CorrelationId: #[correlationId]***" />

    <ee:transform doc:name="Set DB ANY Error Payload &amp; Status Code">
        <ee:message>
            <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    transaction: "Request Correlation ID :" ++ " " ++ correlationId,
    apiName: p('api.name'),
    timestamp: now(),
    infoMessage : { 
        statusCode: 500 as Number,
        errorType: error.errorType.namespace default "" ++ " : " ++ error.errorType.identifier default "",
        message: error.detailedDescription default ""
    }
}]]></ee:set-payload>
        </ee:message>
        <ee:variables>
            <ee:set-variable variableName="httpStatus"><![CDATA[500]]></ee:set-variable>
        </ee:variables>
    </ee:transform>

    <logger level="ERROR" doc:name="End DB ANY Error Log" 
        message="***Generic DB error response sent - 500. CorrelationId: #[correlationId]***" />
</on-error-propagate>

	</error-handler>
</mule>
